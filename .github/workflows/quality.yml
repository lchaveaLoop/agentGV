name: Code Quality

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC

jobs:
  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run Prettier check
        run: npm run format:check

  config-validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate models.json
        run: |
          node -e "JSON.parse(require('fs').readFileSync('.opencode/models.json'))"
          echo "✅ models.json is valid JSON"
      
      - name: Validate skills.json
        run: |
          node -e "JSON.parse(require('fs').readFileSync('.opencode/skills.json'))"
          echo "✅ skills.json is valid JSON"
      
      - name: Validate commands.json
        run: |
          node -e "JSON.parse(require('fs').readFileSync('.opencode/commands.json'))"
          echo "✅ commands.json is valid JSON"
      
      - name: Run config validator
        run: npm run validate

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."
          if find . -name ".env" -o -name "*.pem" -o -name "*secret*" -o -name "*credential*" | grep -v node_modules | grep -v .git; then
            echo "⚠️ Found potentially sensitive files"
          else
            echo "✅ No obvious sensitive files found"
          fi

  code-coverage:
    name: Code Coverage Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from coverage summary
          COVERAGE=$(node -e "
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json'));
            console.log(summary.total.lines.pct);
          ")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage below 80% threshold"
            exit 1
          else
            echo "✅ Coverage meets 80% threshold"
          fi

  quality-gates:
    name: Quality Gates Summary
    runs-on: ubuntu-latest
    needs: [lint, config-validation, security, code-coverage]
    if: always()
    
    steps:
      - name: Check all quality gates
        run: |
          echo "Quality Gates Status:"
          echo "  - Lint: ${{ needs.lint.result }}"
          echo "  - Config Validation: ${{ needs.config-validation.result }}"
          echo "  - Security: ${{ needs.security.result }}"
          echo "  - Code Coverage: ${{ needs.code-coverage.result }}"
          
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.config-validation.result }}" == "failure" ] || \
             [ "${{ needs.code-coverage.result }}" == "failure" ]; then
            echo "❌ Quality gates failed"
            exit 1
          fi
          
          echo "✅ All quality gates passed"
